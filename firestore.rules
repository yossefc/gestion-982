rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function hasRole(role) {
      return isAuthenticated() && request.auth.token.role == role;
    }

    function isAdmin() {
      return hasRole('admin');
    }

    function canAccessArme() {
      return hasRole('admin') || hasRole('both') || hasRole('arme');
    }

    function canAccessVetement() {
      return hasRole('admin') || hasRole('both') || hasRole('vetement');
    }

    // ============================================
    // SOLDIERS
    // ============================================

    match /soldiers/{soldierId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // ============================================
    // USERS
    // ============================================

    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAdmin() || request.auth.uid == userId;
      allow delete: if isAdmin();
    }

    // ============================================
    // EQUIPMENT CATALOGS (MODERN)
    // ============================================

    // Combat Equipment - vérification nameKey + categoryKey côté client
    match /combatEquipment/{equipmentId} {
      allow read: if canAccessArme();
      allow create: if canAccessArme() &&
                       request.resource.data.keys().hasAll(['name', 'nameKey', 'category', 'categoryKey', 'hasSubEquipment']);
      allow update, delete: if canAccessArme();
    }

    // Clothing Equipment - vérification nameKey côté client
    match /clothingEquipment/{equipmentId} {
      allow read: if canAccessVetement();
      allow create: if canAccessVetement() &&
                       request.resource.data.keys().hasAll(['name', 'nameKey']);
      allow update, delete: if canAccessVetement();
    }

    // Manot (packages)
    match /manot/{manaId} {
      allow read: if canAccessArme();
      allow create, update, delete: if canAccessArme();
    }

    // ============================================
    // ASSIGNMENTS (Historique immuable)
    // ============================================

    match /assignments/{assignmentId} {
      allow read: if isAuthenticated();

      // Create: Authentifié + champs requis
      allow create: if isAuthenticated() &&
                       request.resource.data.timestamp is timestamp &&
                       request.resource.data.keys().hasAll(['soldierId', 'type', 'action', 'items', 'status']);

      // Update: Admin ou créateur (pour corrections)
      allow update: if isAdmin() || resource.data.assignedBy == request.auth.uid;

      // Delete: Admin seulement
      allow delete: if isAdmin();
    }

    // ============================================
    // SOLDIER HOLDINGS (État courant)
    // ============================================

    match /soldier_holdings/{holdingId} {
      allow read: if isAuthenticated();

      // Write: Authentifié (géré par transactions côté serveur)
      allow create, update: if isAuthenticated() &&
                               request.resource.data.keys().hasAll(['soldierId', 'type', 'items', 'outstandingCount', 'status', 'lastUpdated']);

      allow delete: if isAdmin();
    }

    // ============================================
    // WEAPON INVENTORY
    // ============================================

    match /weapons_inventory/{weaponId} {
      allow read: if canAccessArme();
      allow create, update, delete: if canAccessArme();
    }

    // ============================================
    // LOGS (Audit trail - immutable)
    // ============================================

    match /logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if false; // Logs are immutable
    }

    // ============================================
    // LEGACY COLLECTIONS (BLOQUÉS - À SUPPRIMER)
    // ============================================

    match /equipment_combat/{id} {
      allow read: if isAuthenticated();
      allow write: if false; // DEPRECATED - use combatEquipment
    }

    match /equipment_clothing/{id} {
      allow read: if isAuthenticated();
      allow write: if false; // DEPRECATED - use clothingEquipment
    }

    match /soldier_equipment/{id} {
      allow read: if isAuthenticated();
      allow write: if false; // DEPRECATED - use soldier_holdings
    }
  }
}
